AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Rasyn Retrosynthesis API — Production GPU infrastructure.
  Runs directly on EC2 (no Docker) using Deep Learning AMI.

Parameters:
  EnvironmentName:
    Type: String
    Default: rasyn-prod
    Description: Name prefix for all resources

  InstanceType:
    Type: String
    Default: g5.xlarge
    AllowedValues:
      - g4dn.xlarge    # T4 16GB  — $0.53/hr
      - g4dn.2xlarge   # T4 16GB  — $0.75/hr (more CPU/RAM)
      - g5.xlarge      # A10G 24GB — $1.01/hr
      - g5.2xlarge     # A10G 24GB — $1.21/hr (more CPU/RAM)
      - p3.2xlarge     # V100 16GB — $3.06/hr
    Description: EC2 GPU instance type

  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: SSH key pair for EC2 access

  AmiId:
    Type: AWS::EC2::Image::Id
    Description: Deep Learning AMI (Ubuntu 22.04) with NVIDIA drivers

  S3ModelsBucket:
    Type: String
    Description: S3 bucket name containing model checkpoints

  GitRepoUrl:
    Type: String
    Default: https://github.com/ansschh/rasyn.git
    Description: Git repository URL

  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC to deploy into (use default VPC)

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: At least 2 subnets in different AZs (for ALB)

  AllowedSSHCidr:
    Type: String
    Default: "0.0.0.0/0"
    Description: CIDR block allowed to SSH (restrict for security)

Resources:
  # ============================================================
  # Security Groups
  # ============================================================
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${EnvironmentName} ALB"
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-alb-sg"

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${EnvironmentName} EC2 GPU instances"
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedSSHCidr
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8000
          SourceSecurityGroupId: !GetAtt ALBSecurityGroup.GroupId
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-ec2-sg"

  # ============================================================
  # IAM Role — EC2 can read S3 and write CloudWatch
  # ============================================================
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${EnvironmentName}-ec2-role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Policies:
        - PolicyName: S3ModelReadAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::${S3ModelsBucket}"
                  - !Sub "arn:aws:s3:::${S3ModelsBucket}/*"

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub "${EnvironmentName}-ec2-profile"
      Roles:
        - !Ref EC2Role

  # ============================================================
  # CloudWatch Log Group
  # ============================================================
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/rasyn/${EnvironmentName}"
      RetentionInDays: 30

  # ============================================================
  # Application Load Balancer
  # ============================================================
  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${EnvironmentName}-alb"
      Scheme: internet-facing
      Type: application
      Subnets: !Ref SubnetIds
      SecurityGroups:
        - !GetAtt ALBSecurityGroup.GroupId

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentName}-tg"
      Protocol: HTTP
      Port: 8000
      VpcId: !Ref VpcId
      TargetType: instance
      HealthCheckPath: /api/v1/health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 5
      Matcher:
        HttpCode: "200"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: "30"

  HTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

  # ============================================================
  # Launch Template — Direct Python execution (no Docker)
  # ============================================================
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub "${EnvironmentName}-lt"
      LaunchTemplateData:
        InstanceType: !Ref InstanceType
        ImageId: !Ref AmiId
        KeyName: !Ref KeyPairName
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        SecurityGroupIds:
          - !GetAtt EC2SecurityGroup.GroupId
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeSize: 150
              VolumeType: gp3
              Iops: 3000
              Throughput: 250
              DeleteOnTermination: true
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${EnvironmentName}-gpu"
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -euo pipefail
            exec > >(tee /var/log/rasyn-init.log) 2>&1
            echo "=== Rasyn bootstrap starting $(date) ==="

            export DEBIAN_FRONTEND=noninteractive
            APP_DIR=/opt/rasyn
            MODEL_DIR=$APP_DIR/models

            # --- System packages ---
            apt-get update -y
            apt-get install -y --no-install-recommends \
              git python3-pip python3-venv libxrender1 libxext6 awscli

            # --- Clone repository ---
            echo "Cloning repository..."
            git clone ${GitRepoUrl} $APP_DIR/app
            cd $APP_DIR/app

            # --- Python virtual environment ---
            echo "Creating Python environment..."
            python3 -m venv $APP_DIR/venv
            source $APP_DIR/venv/bin/activate

            # Install PyTorch with CUDA first (the AMI may have it system-wide, but venv needs it)
            pip install --no-cache-dir torch==2.4.0 --index-url https://download.pytorch.org/whl/cu121

            # Install project requirements
            pip install --no-cache-dir -r requirements.txt

            # --- Download model checkpoints from S3 ---
            echo "Downloading models from S3..."
            mkdir -p $APP_DIR/app/checkpoints $APP_DIR/app/weights $APP_DIR/app/data

            aws s3 sync s3://${S3ModelsBucket}/models/checkpoints/ $APP_DIR/app/checkpoints/ --only-show-errors
            aws s3 sync s3://${S3ModelsBucket}/models/weights/ $APP_DIR/app/weights/ --only-show-errors
            aws s3 sync s3://${S3ModelsBucket}/models/data/ $APP_DIR/app/data/ --only-show-errors

            echo "Models downloaded:"
            find $APP_DIR/app/checkpoints $APP_DIR/app/weights -type f -exec ls -lh {} \;

            # --- Create systemd service ---
            cat > /etc/systemd/system/rasyn.service <<SYSTEMD
            [Unit]
            Description=Rasyn Retrosynthesis API
            After=network.target

            [Service]
            Type=simple
            User=root
            WorkingDirectory=$APP_DIR/app
            Environment=PATH=$APP_DIR/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
            Environment=CUDA_VISIBLE_DEVICES=0
            ExecStart=$APP_DIR/venv/bin/uvicorn rasyn.api.app:app --host 0.0.0.0 --port 8000 --workers 1
            Restart=always
            RestartSec=10

            [Install]
            WantedBy=multi-user.target
            SYSTEMD

            systemctl daemon-reload
            systemctl enable rasyn
            systemctl start rasyn

            echo "=== Rasyn bootstrap complete $(date) ==="
            echo "Service status:"
            systemctl status rasyn --no-pager || true

  # ============================================================
  # Auto Scaling Group (self-healing, min=max=1)
  # ============================================================
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub "${EnvironmentName}-asg"
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: 1
      MaxSize: 1
      DesiredCapacity: 1
      TargetGroupARNs:
        - !Ref TargetGroup
      VPCZoneIdentifier: !Ref SubnetIds
      HealthCheckType: ELB
      HealthCheckGracePeriod: 900
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-gpu"
          PropagateAtLaunch: true

Outputs:
  ALBEndpoint:
    Description: API endpoint (ALB DNS)
    Value: !Sub "http://${ALB.DNSName}"

  ALBDNSName:
    Description: ALB DNS name (for Route 53 CNAME/alias)
    Value: !GetAtt ALB.DNSName

  LogGroupName:
    Description: CloudWatch log group
    Value: !Ref LogGroup

  SecurityGroupId:
    Description: EC2 security group ID
    Value: !GetAtt EC2SecurityGroup.GroupId
