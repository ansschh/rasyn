AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Rasyn Chemistry OS — Production GPU infrastructure.
  Runs FastAPI + Celery worker + PostgreSQL + Redis on EC2 (no Docker).

Parameters:
  EnvironmentName:
    Type: String
    Default: rasyn-prod
    Description: Name prefix for all resources

  InstanceType:
    Type: String
    Default: g5.xlarge
    AllowedValues:
      - g4dn.xlarge    # T4 16GB  — $0.53/hr
      - g4dn.2xlarge   # T4 16GB  — $0.75/hr (more CPU/RAM)
      - g5.xlarge      # A10G 24GB — $1.01/hr
      - g5.2xlarge     # A10G 24GB — $1.21/hr (more CPU/RAM)
      - p3.2xlarge     # V100 16GB — $3.06/hr
    Description: EC2 GPU instance type

  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: SSH key pair for EC2 access

  AmiId:
    Type: AWS::EC2::Image::Id
    Description: Deep Learning AMI (Ubuntu 22.04) with NVIDIA drivers

  S3ModelsBucket:
    Type: String
    Description: S3 bucket name containing model checkpoints

  GitRepoUrl:
    Type: String
    Default: https://github.com/ansschh/rasyn.git
    Description: Git repository URL

  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC to deploy into (use default VPC)

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: At least 2 subnets in different AZs (for ALB)

  AllowedSSHCidr:
    Type: String
    Default: "0.0.0.0/0"
    Description: CIDR block allowed to SSH (restrict for security)

Resources:
  # ============================================================
  # Security Groups
  # ============================================================
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${EnvironmentName} ALB"
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-alb-sg"

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${EnvironmentName} EC2 GPU instances"
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedSSHCidr
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8000
          SourceSecurityGroupId: !GetAtt ALBSecurityGroup.GroupId
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-ec2-sg"

  # ============================================================
  # IAM Role — EC2 can read S3 and write CloudWatch
  # ============================================================
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${EnvironmentName}-ec2-role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Policies:
        - PolicyName: S3ModelReadAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::${S3ModelsBucket}"
                  - !Sub "arn:aws:s3:::${S3ModelsBucket}/*"

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub "${EnvironmentName}-ec2-profile"
      Roles:
        - !Ref EC2Role

  # ============================================================
  # CloudWatch Log Group
  # ============================================================
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/rasyn/${EnvironmentName}"
      RetentionInDays: 30

  # ============================================================
  # Application Load Balancer
  # ============================================================
  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${EnvironmentName}-alb"
      Scheme: internet-facing
      Type: application
      Subnets: !Ref SubnetIds
      SecurityGroups:
        - !GetAtt ALBSecurityGroup.GroupId
      LoadBalancerAttributes:
        # SSE connections need longer idle timeout (default 60s is too short)
        - Key: idle_timeout.timeout_seconds
          Value: "300"

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentName}-tg"
      Protocol: HTTP
      Port: 8000
      VpcId: !Ref VpcId
      TargetType: instance
      HealthCheckPath: /api/v1/health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 5
      Matcher:
        HttpCode: "200"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: "30"

  HTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

  # ============================================================
  # Launch Template — Direct Python execution (no Docker)
  # ============================================================
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub "${EnvironmentName}-lt"
      LaunchTemplateData:
        InstanceType: !Ref InstanceType
        ImageId: !Ref AmiId
        KeyName: !Ref KeyPairName
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        SecurityGroupIds:
          - !GetAtt EC2SecurityGroup.GroupId
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeSize: 150
              VolumeType: gp3
              Iops: 3000
              Throughput: 250
              DeleteOnTermination: true
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${EnvironmentName}-gpu"
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -euo pipefail
            exec > >(tee /var/log/rasyn-init.log) 2>&1
            echo "=== Rasyn Chemistry OS bootstrap starting $(date) ==="

            export DEBIAN_FRONTEND=noninteractive
            APP_DIR=/opt/rasyn
            DB_NAME=rasyn
            DB_USER=rasyn
            DB_PASS=rasyn_prod_$(openssl rand -hex 8)

            # --- System packages + PostgreSQL 16 + Redis ---
            apt-get update -y
            apt-get install -y --no-install-recommends \
              git python3-pip python3-venv libxrender1 libxext6 awscli \
              curl gnupg lsb-release

            # PostgreSQL 16 with pgvector
            curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /usr/share/keyrings/pgdg.gpg
            echo "deb [signed-by=/usr/share/keyrings/pgdg.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list
            apt-get update -y
            apt-get install -y postgresql-16 postgresql-16-pgvector

            # Redis
            apt-get install -y redis-server

            # --- Configure PostgreSQL ---
            echo "Configuring PostgreSQL..."
            systemctl enable postgresql
            systemctl start postgresql

            sudo -u postgres psql -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';" || true
            sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER $DB_USER;" || true
            sudo -u postgres psql -d $DB_NAME -c "CREATE EXTENSION IF NOT EXISTS vector;" || true

            # Allow local connections with password
            PG_HBA=$(sudo -u postgres psql -t -c "SHOW hba_file;" | xargs)
            sed -i 's/local\s\+all\s\+all\s\+peer/local   all   all   md5/' "$PG_HBA"
            echo "host  all  all  127.0.0.1/32  md5" >> "$PG_HBA"
            systemctl restart postgresql

            # --- Configure Redis ---
            echo "Configuring Redis..."
            sed -i 's/^supervised no/supervised systemd/' /etc/redis/redis.conf || true
            systemctl enable redis-server
            systemctl restart redis-server

            # --- Clone repository ---
            echo "Cloning repository..."
            git clone ${GitRepoUrl} $APP_DIR/app
            cd $APP_DIR/app

            # --- Python virtual environment ---
            echo "Creating Python environment..."
            python3 -m venv $APP_DIR/venv
            source $APP_DIR/venv/bin/activate

            # Install PyTorch with CUDA first
            pip install --no-cache-dir torch==2.4.0 --index-url https://download.pytorch.org/whl/cu121

            # Install project requirements (includes sqlalchemy, celery, redis, asyncpg, psycopg2)
            pip install --no-cache-dir -r requirements.txt

            # --- Download model checkpoints from S3 ---
            echo "Downloading models from S3..."
            mkdir -p $APP_DIR/app/checkpoints $APP_DIR/app/weights $APP_DIR/app/data

            aws s3 sync s3://${S3ModelsBucket}/models/checkpoints/ $APP_DIR/app/checkpoints/ --only-show-errors
            aws s3 sync s3://${S3ModelsBucket}/models/weights/ $APP_DIR/app/weights/ --only-show-errors
            aws s3 sync s3://${S3ModelsBucket}/models/data/ $APP_DIR/app/data/ --only-show-errors

            echo "Models downloaded:"
            find $APP_DIR/app/checkpoints $APP_DIR/app/weights -type f -exec ls -lh {} \;

            # --- Save database credentials ---
            cat > $APP_DIR/env <<ENVFILE
            DATABASE_URL=postgresql+asyncpg://$DB_USER:$DB_PASS@localhost:5432/$DB_NAME
            DATABASE_URL_SYNC=postgresql+psycopg2://$DB_USER:$DB_PASS@localhost:5432/$DB_NAME
            REDIS_URL=redis://localhost:6379/0
            CUDA_VISIBLE_DEVICES=0
            RASYN_CORS_ORIGINS=*
            ENVFILE

            # --- Systemd: Rasyn API ---
            cat > /etc/systemd/system/rasyn-api.service <<SYSTEMD
            [Unit]
            Description=Rasyn Chemistry OS - API Server
            After=network.target postgresql.service redis-server.service
            Requires=postgresql.service redis-server.service

            [Service]
            Type=simple
            User=root
            WorkingDirectory=$APP_DIR/app
            EnvironmentFile=$APP_DIR/env
            Environment=PATH=$APP_DIR/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
            ExecStart=$APP_DIR/venv/bin/uvicorn rasyn.api.app:app --host 0.0.0.0 --port 8000 --workers 1
            Restart=always
            RestartSec=10

            [Install]
            WantedBy=multi-user.target
            SYSTEMD

            # --- Systemd: Celery Worker (GPU inference) ---
            cat > /etc/systemd/system/rasyn-worker.service <<SYSTEMD
            [Unit]
            Description=Rasyn Chemistry OS - Celery Worker
            After=network.target postgresql.service redis-server.service rasyn-api.service
            Requires=postgresql.service redis-server.service

            [Service]
            Type=simple
            User=root
            WorkingDirectory=$APP_DIR/app
            EnvironmentFile=$APP_DIR/env
            Environment=PATH=$APP_DIR/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
            ExecStart=$APP_DIR/venv/bin/celery -A rasyn.worker.app worker --loglevel=info --concurrency=1
            Restart=always
            RestartSec=10

            [Install]
            WantedBy=multi-user.target
            SYSTEMD

            # --- Start all services ---
            systemctl daemon-reload
            systemctl enable rasyn-api rasyn-worker
            systemctl start rasyn-api
            # Wait for API to init DB tables before starting worker
            sleep 5
            systemctl start rasyn-worker

            echo "=== Rasyn Chemistry OS bootstrap complete $(date) ==="
            echo ""
            echo "Service statuses:"
            systemctl status postgresql --no-pager || true
            systemctl status redis-server --no-pager || true
            systemctl status rasyn-api --no-pager || true
            systemctl status rasyn-worker --no-pager || true
            echo ""
            echo "DB credentials saved to $APP_DIR/env"

  # ============================================================
  # Auto Scaling Group (self-healing, min=max=1)
  # ============================================================
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub "${EnvironmentName}-asg"
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: 1
      MaxSize: 1
      DesiredCapacity: 1
      TargetGroupARNs:
        - !Ref TargetGroup
      VPCZoneIdentifier: !Ref SubnetIds
      HealthCheckType: ELB
      HealthCheckGracePeriod: 900
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-gpu"
          PropagateAtLaunch: true

Outputs:
  ALBEndpoint:
    Description: API endpoint (ALB DNS)
    Value: !Sub "http://${ALB.DNSName}"

  ALBDNSName:
    Description: ALB DNS name (for Route 53 CNAME/alias)
    Value: !GetAtt ALB.DNSName

  LogGroupName:
    Description: CloudWatch log group
    Value: !Ref LogGroup

  SecurityGroupId:
    Description: EC2 security group ID
    Value: !GetAtt EC2SecurityGroup.GroupId
